<div class="recommendations-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <i class="pi pi-compass"></i>
        Motor de Recomandări
      </h1>
      <p class="subtitle">Găsește cea mai potrivită instituție pentru nevoile tale</p>
    </div>
    
    <div class="design-patterns-badge">
      <p-tag severity="info" [value]="compositeMode() ? '5 Design Patterns' : '4 Design Patterns'" />
      <span class="patterns-list">
        Strategy • Factory • Decorator • Template Method
        @if (compositeMode()) {
          • <strong>Composite</strong>
        }
      </span>
    </div>
  </div>

  <!-- Composite Mode Toggle -->
  <div class="mode-toggle-section">
    <div class="mode-toggle">
      <span class="mode-label" [class.active]="!compositeMode()">Mod Simplu</span>
      <p-toggleButton 
        [(ngModel)]="compositeMode"
        onLabel=""
        offLabel=""
        onIcon="pi pi-sliders-h"
        offIcon="pi pi-sliders-h"
        (onChange)="toggleCompositeMode()"
        styleClass="mode-switch" />
      <span class="mode-label" [class.active]="compositeMode()">Mod Avansat (Composite)</span>
    </div>
    @if (compositeMode()) {
      <p class="composite-hint">
        <i class="pi pi-info-circle"></i>
        Combină mai multe strategii cu ponderi personalizate
      </p>
    }
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-group">
      <label>Serviciu dorit</label>
      <p-select 
        [options]="services" 
        [(ngModel)]="selectedService"
        optionLabel="label"
        optionValue="value"
        placeholder="Selectează serviciul"
        (onChange)="getRecommendations()"
        styleClass="w-full" />
    </div>

    <div class="filter-group">
      <label>Județul tău</label>
      <p-select 
        [options]="counties" 
        [(ngModel)]="selectedCounty"
        optionLabel="label"
        optionValue="value"
        placeholder="Selectează județul"
        (onChange)="getRecommendations()"
        styleClass="w-full" />
    </div>

    @if (!compositeMode()) {
      <div class="filter-group">
        <label>Strategie de recomandare</label>
        <p-select 
          [options]="strategyOptions()" 
          [(ngModel)]="selectedStrategy"
          optionLabel="label"
          optionValue="value"
          placeholder="Selectează strategia"
          (onChange)="getRecommendations()"
          styleClass="w-full" />
      </div>
    }
  </div>

  <!-- COMPOSITE Pattern - Sliders pentru ponderi -->
  @if (compositeMode()) {
    <div class="composite-section">
      <div class="composite-header">
        <h3><i class="pi pi-sliders-h"></i> Configurare Ponderi</h3>
        <div class="weight-total" [class.valid]="weightsValid()" [class.invalid]="!weightsValid()">
          Total: {{ totalWeight() }}%
          @if (!weightsValid()) {
            <button class="normalize-btn" (click)="normalizeWeights()">
              <i class="pi pi-sync"></i> Normalizează
            </button>
          }
        </div>
      </div>
      
      <div class="sliders-grid">
        @for (entry of strategyWeights() | keyvalue; track entry.key) {
          <div class="slider-item">
            <div class="slider-header">
              <span class="slider-label">
                <i class="pi" [ngClass]="strategyIcons[entry.key]"></i>
                {{ strategyLabels[entry.key] }}
              </span>
              <span class="slider-value">{{ entry.value }}%</span>
            </div>
            <p-slider 
              [ngModel]="entry.value"
              (ngModelChange)="updateWeight(entry.key, $event)"
              [min]="0" 
              [max]="100" 
              [step]="5"
              styleClass="custom-slider" />
          </div>
        }
      </div>

      <div class="composite-actions">
        <p-button 
          label="Obține Recomandări Compozite" 
          icon="pi pi-sparkles"
          [disabled]="!weightsValid()"
          (onClick)="getRecommendations()"
          severity="success" />
      </div>
    </div>
  }

  <!-- Strategy Info -->
  @if (response()) {
    <div class="strategy-info">
      <div class="strategy-badge">
        <i class="pi" [ngClass]="getStrategyIcon()"></i>
        <span>{{ response()?.strategyDescription }}</span>
      </div>
      <div class="processing-time">
        <i class="pi pi-clock"></i>
        Procesat în {{ response()?.processingTimeMs }}ms
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (loading()) {
    <div class="recommendations-grid">
      @for (i of [1, 2, 3, 4, 5]; track i) {
        <div class="recommendation-card skeleton-card">
          <p-skeleton width="60%" height="1.5rem" />
          <p-skeleton width="40%" height="1rem" styleClass="mt-2" />
          <p-skeleton width="100%" height="0.5rem" styleClass="mt-3" />
          <p-skeleton width="80%" height="1rem" styleClass="mt-2" />
        </div>
      }
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <p-message severity="error" [text]="error()!" styleClass="w-full" />
  }

  <!-- Results -->
  @if (!loading() && recommendations().length > 0) {
    <div class="recommendations-grid">
      @for (rec of recommendations(); track rec.institutionId) {
        <div class="recommendation-card" [class.boosted]="rec.boosted" (click)="selectInstitution(rec)">
          <!-- Rank Badge -->
          <div class="rank-badge" [class.top-rank]="rec.rank === 1">
            @if (rec.rank === 1) {
              <i class="pi pi-trophy"></i>
            } @else {
              #{{ rec.rank }}
            }
          </div>

          <!-- Boosted Badge -->
          @if (rec.boosted) {
            <div class="boosted-badge" pTooltip="{{ rec.boostReason }}">
              <i class="pi pi-bolt"></i> Top
            </div>
          }

          <!-- Header -->
          <div class="card-header">
            <h3>{{ rec.institutionName }}</h3>
            <p-tag [value]="rec.county" severity="secondary" />
          </div>

          <!-- Score -->
          <div class="score-section">
            <div class="score-label">Scor potrivire</div>
            <div class="score-bar">
              <p-progressBar 
                [value]="rec.score" 
                [showValue]="false"
                [style]="{ height: '8px' }"
                [styleClass]="'score-' + getScoreColor(rec.score)" />
            </div>
            <div class="score-value">
              <p-tag [value]="rec.score.toFixed(0) + '%'" [severity]="getScoreSeverity(rec.score)" />
            </div>
          </div>

          <!-- Details based on strategy -->
          <div class="details-section">
            @if (rec.distance !== undefined && rec.distance > 0) {
              <div class="detail-item">
                <i class="pi pi-map-marker"></i>
                <span>{{ formatDistance(rec.distance) }}</span>
              </div>
            }
            
            @if (rec.waitTimeHours !== undefined) {
              <div class="detail-item">
                <i class="pi pi-clock"></i>
                <span>Disponibil în {{ formatWaitTime(rec.waitTimeHours) }}</span>
              </div>
            }
            
            @if (rec.rating !== undefined) {
              <div class="detail-item">
                <i class="pi pi-star-fill" style="color: #f59e0b;"></i>
                <span>{{ rec.rating.toFixed(1) }} ({{ rec.totalReviews }} recenzii)</span>
              </div>
            }
            
            @if (rec.occupancyRate !== undefined) {
              <div class="detail-item">
                <i class="pi pi-chart-bar"></i>
                <span>{{ rec.occupancyRate.toFixed(0) }}% ocupat</span>
              </div>
            }

            @if (rec.availableSlots !== undefined) {
              <div class="detail-item">
                <i class="pi pi-calendar"></i>
                <span>{{ rec.availableSlots }} sloturi libere</span>
              </div>
            }
          </div>

          <!-- Reason -->
          <div class="reason-section">
            <i class="pi pi-info-circle"></i>
            <span>{{ rec.reason }}</span>
          </div>

          <!-- Action -->
          <div class="card-action">
            <p-button 
              label="Programează-te aici" 
              icon="pi pi-arrow-right" 
              iconPos="right"
              styleClass="w-full" />
          </div>
        </div>
      }
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && recommendations().length === 0 && !error()) {
    <div class="empty-state">
      <i class="pi pi-search"></i>
      <h3>Nu am găsit recomandări</h3>
      <p>Încearcă să schimbi criteriile de căutare</p>
    </div>
  }
</div>
